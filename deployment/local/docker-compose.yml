# Local Archival Pipeline Prototype
# Full stack: PostgreSQL, 3-node CCS cluster, filelister, ntx, and web UI

services:
  # ============================================================================
  # DATABASE
  # ============================================================================

  postgres:
    image: postgres:16
    container_name: archival-postgres
    environment:
      POSTGRES_DB: scottfiles
      POSTGRES_USER: archival
      POSTGRES_PASSWORD: dev-password-change-in-production
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ../../database/init:/docker-entrypoint-initdb.d
    ports:
      - "5432:5432"
    networks:
      archival-net:
        ipv4_address: 172.30.0.10
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U archival -d scottfiles"]
      interval: 5s
      timeout: 3s
      retries: 5

  # ============================================================================
  # CCS CLUSTER (3 nodes - one cluster with multiple peers)
  # ============================================================================

  # Cluster Node 1: Primary for test-org1
  ccs-node1-ipfs:
    image: ipfs/kubo:latest
    container_name: ccs-node1-ipfs
    entrypoint: /custom-entrypoint.sh
    environment:
      - LIBP2P_FORCE_PNET=1
    volumes:
      - node1-ipfs-data:/data/ipfs
      - ./ccs-config/swarm.key:/data/ipfs/swarm.key
      - ./ipfs-init/entrypoint.sh:/custom-entrypoint.sh:ro
    networks:
      archival-net:
        ipv4_address: 172.30.0.21

  ccs-node1-cluster:
    image: ipfs/ipfs-cluster:latest
    container_name: ccs-node1-cluster
    depends_on:
      - ccs-node1-ipfs
    environment:
      - CLUSTER_PEERNAME=node1
      - CLUSTER_SECRET=${CLUSTER_SECRET}
      - CLUSTER_IPFSHTTP_NODEMULTIADDRESS=/ip4/172.30.0.21/tcp/5001
      - CLUSTER_RESTAPI_HTTPLISTENMULTIADDRESS=/ip4/0.0.0.0/tcp/9094
      - CLUSTER_REPLICATIONFACTORMIN=2
      - CLUSTER_REPLICATIONFACTORMAX=3
      - CLUSTER_DISABLEREPINNING=false
      - CLUSTER_INFORMER_TAGS_TAGS={"role":"primary","org":"test-org1"}
    volumes:
      - node1-cluster-data:/data/ipfs-cluster
    ports:
      - "9094:9094"
      - "9096:9096"
    networks:
      archival-net:
        ipv4_address: 172.30.0.31

  # Cluster Node 2: Backup node
  ccs-node2-ipfs:
    image: ipfs/kubo:latest
    container_name: ccs-node2-ipfs
    entrypoint: /custom-entrypoint.sh
    environment:
      - LIBP2P_FORCE_PNET=1
    volumes:
      - node2-ipfs-data:/data/ipfs
      - ./ccs-config/swarm.key:/data/ipfs/swarm.key
      - ./ipfs-init/entrypoint.sh:/custom-entrypoint.sh:ro
    networks:
      archival-net:
        ipv4_address: 172.30.0.22

  ccs-node2-cluster:
    image: ipfs/ipfs-cluster:latest
    container_name: ccs-node2-cluster
    depends_on:
      - ccs-node2-ipfs
      - ccs-node1-cluster
    environment:
      - CLUSTER_PEERNAME=node2
      - CLUSTER_SECRET=${CLUSTER_SECRET}
      - CLUSTER_IPFSHTTP_NODEMULTIADDRESS=/ip4/172.30.0.22/tcp/5001
      - CLUSTER_RESTAPI_HTTPLISTENMULTIADDRESS=/ip4/0.0.0.0/tcp/9094
      - CLUSTER_REPLICATIONFACTORMIN=2
      - CLUSTER_REPLICATIONFACTORMAX=3
      - CLUSTER_DISABLEREPINNING=false
      - CLUSTER_INFORMER_TAGS_TAGS={"role":"backup","org":"shared"}
    volumes:
      - node2-cluster-data:/data/ipfs-cluster
    ports:
      - "9095:9094"
      - "9097:9096"
    networks:
      archival-net:
        ipv4_address: 172.30.0.32

  # Cluster Node 3: Primary for test-org2
  ccs-node3-ipfs:
    image: ipfs/kubo:latest
    container_name: ccs-node3-ipfs
    entrypoint: /custom-entrypoint.sh
    environment:
      - LIBP2P_FORCE_PNET=1
    volumes:
      - node3-ipfs-data:/data/ipfs
      - ./ccs-config/swarm.key:/data/ipfs/swarm.key
      - ./ipfs-init/entrypoint.sh:/custom-entrypoint.sh:ro
    networks:
      archival-net:
        ipv4_address: 172.30.0.23

  ccs-node3-cluster:
    image: ipfs/ipfs-cluster:latest
    container_name: ccs-node3-cluster
    depends_on:
      - ccs-node3-ipfs
      - ccs-node1-cluster
    environment:
      - CLUSTER_PEERNAME=node3
      - CLUSTER_SECRET=${CLUSTER_SECRET}
      - CLUSTER_IPFSHTTP_NODEMULTIADDRESS=/ip4/172.30.0.23/tcp/5001
      - CLUSTER_RESTAPI_HTTPLISTENMULTIADDRESS=/ip4/0.0.0.0/tcp/9094
      - CLUSTER_REPLICATIONFACTORMIN=2
      - CLUSTER_REPLICATIONFACTORMAX=3
      - CLUSTER_DISABLEREPINNING=false
      - CLUSTER_INFORMER_TAGS_TAGS={"role":"primary","org":"test-org2"}
    volumes:
      - node3-cluster-data:/data/ipfs-cluster
    ports:
      - "9098:9094"
      - "9099:9096"
    networks:
      archival-net:
        ipv4_address: 172.30.0.33

  # ============================================================================
  # ARCHIVAL API SERVICE
  # ============================================================================

  archival-api:
    build:
      context: ../../api
      dockerfile: Dockerfile
    container_name: archival-api
    depends_on:
      postgres:
        condition: service_healthy
      ccs-node1-cluster:
        condition: service_started
    environment:
      - DATABASE_URL=postgresql://archival:dev-password-change-in-production@postgres:5432/scottfiles
      - UPLOAD_DIR=/uploads
      - STAGING_DIR=/staging
      - IPFS_API_ADDR=/ip4/172.30.0.21/tcp/5001
      - CCS_PROFILE=test-org1
    volumes:
      - upload-data:/uploads
      - staging-data:/staging
      - ../filelister:/app/filelister
      - ../ntx:/app/ntx
      - .:/app/community-cloud-storage
    ports:
      - "8000:8000"
    networks:
      archival-net:
        ipv4_address: 172.30.0.40

  # ============================================================================
  # WEB UI
  # ============================================================================

  web-ui:
    build:
      context: ../../ui
      dockerfile: Dockerfile
    container_name: archival-web-ui
    depends_on:
      - archival-api
    environment:
      - VITE_API_URL=http://localhost:8000
    ports:
      - "3000:80"
    networks:
      archival-net:
        ipv4_address: 172.30.0.50

volumes:
  postgres-data:
  node1-ipfs-data:
  node1-cluster-data:
  node2-ipfs-data:
  node2-cluster-data:
  node3-ipfs-data:
  node3-cluster-data:
  upload-data:
  staging-data:

networks:
  archival-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.30.0.0/24
