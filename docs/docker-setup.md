<!--
Author: PB and Claude
Date: 2025-01-09
License: (c) HRDAG, 2025, GPL-2 or newer

---
docs/docker-setup.md
-->

# Docker Compose Setup Guide

This guide explains how to deploy CCS (Community Cloud Storage) nodes using Docker Compose.

## Architecture Overview

Each CCS node runs three containers:

| Container | Purpose |
|-----------|---------|
| `tailscale` | VPN networking, gives node a hostname on tailnet |
| `ipfs` | IPFS daemon (kubo) - content storage |
| `ipfs-cluster` | Cluster coordination - replication, pinning |

### Port Reference

| Port | Service | Purpose | Access |
|------|---------|---------|--------|
| 4001 | IPFS | Swarm (peer-to-peer replication) | Tailnet (CCS nodes) |
| 5001 | IPFS | API (read/write) | Localhost only |
| 8080 | IPFS | Gateway (read-only HTTP) | Tailnet |
| 9094 | Cluster | REST API (add/rm/ls/status) | Tailnet + basic auth |
| 9096 | Cluster | Swarm (cluster peer-to-peer) | Tailnet (CCS nodes) |

**Security notes:**
- Port 5001 is hardened to localhost only (`CLUSTER_IPFSHTTP_NODEMULTIADDRESS`)
- Port 9094 requires basic auth credentials
- Ports 4001 and 9096 are for inter-node communication only

## Secrets and How They're Shared

CCS uses two secrets that must be identical across all nodes in a cluster:

| Secret | Purpose | Generated By |
|--------|---------|--------------|
| `CLUSTER_SECRET` | Authenticates cluster peers to each other | `ccs create` on bootstrap node |
| `IPFS_SWARM_KEY` | Creates private IPFS network (nodes only talk to each other) | `ccs create` on bootstrap node |

**Key principle:** Secrets are generated once on the bootstrap node, then automatically extracted and copied when cloning new nodes.

## Prerequisites

1. **Docker** installed on target machine
2. **Tailscale auth key** - get from https://login.tailscale.com/admin/settings/keys
   - Use a reusable key for multiple nodes
   - Save to a file (e.g., `~/.ts-authkey`)
3. **CCS installed** on your workstation (see `install.sh`)

## Step 1: Create Bootstrap Node

The first node in the cluster generates the shared secrets.

### On your workstation:

```bash
# Generate compose.yml for bootstrap node
ccs create \
  --cluster-peername nas-ccs \
  --ts-authkey-file ~/.ts-authkey \
  --output compose.yml
```

### On the target machine:

```bash
# Copy compose.yml to target
scp compose.yml nas:/mnt/hrdag-nas/ccs/

# SSH to target and start
ssh nas
cd /mnt/hrdag-nas/ccs
docker compose up -d
```

### Verify bootstrap node:

```bash
# Check containers are running
docker compose ps

# Check IPFS is healthy
docker compose exec ipfs ipfs id

# Check cluster is running
docker compose exec ipfs-cluster ipfs-cluster-ctl id
```

## Step 2: Add Nodes to Cluster

Additional nodes clone their config from the bootstrap node.

### On your workstation:

```bash
# Clone config from bootstrap node
ccs clone \
  --cluster-peername meerkat-ccs \
  --bootstrap-host nas-ccs \
  --ts-authkey-file ~/.ts-authkey \
  --basic-auth admin:yourpassword \
  --input nas-compose.yml \
  --output meerkat-compose.yml
```

The `clone` command:
1. Reads secrets from the bootstrap node's compose.yml
2. Queries the bootstrap node for its peer IDs
3. Generates bootstrap multiaddrs so the new node can find the cluster
4. Writes a new compose.yml with all the right values

### On the target machine:

```bash
# Copy and start
scp meerkat-compose.yml meerkat:/mnt/sda1/ccs/compose.yml
ssh meerkat
cd /mnt/sda1/ccs
sudo docker compose up -d
```

### Verify node joined cluster:

```bash
# From your workstation
ccs ls --cluster-peername nas-ccs --basic-auth-file ~/.ccs/config.yml

# Should show both peers in peer_map
```

## Directory Structure on Nodes

```
/path/to/ccs/
├── compose.yml          # Docker compose config (contains secrets!)
├── incoming/            # Optional: for batch imports
├── ipfs/                # IPFS data (blocks, datastore)
├── ipfs-cluster/        # Cluster state (pins, peer info)
└── tailscale/           # Tailscale state
```

**Important:** The `compose.yml` contains secrets. Protect it appropriately.

## Security Notes

### Verifying Port Security

After setup, verify port 5001 is locked down:

```bash
# Should fail with "connection refused"
curl -m 5 -X POST http://node-ccs:5001/api/v0/id
```

### Hardening IPFS API (Port 5001)

The IPFS API should not be exposed to the network:

```bash
# On the node
docker compose exec ipfs ipfs config Addresses.API /ip4/127.0.0.1/tcp/5001
docker compose restart ipfs
```

This is configured in the compose template (`CLUSTER_IPFSHTTP_NODEMULTIADDRESS`).

## Troubleshooting

### Node can't find peers

```bash
# Check cluster peer list
docker compose exec ipfs-cluster ipfs-cluster-ctl peers ls

# Manually add bootstrap peer
ccs set-bootstrap-peer --cluster-peername meerkat-ccs --bootstrap-host nas-ccs
```

### Reset bootstrap peers

If a node has stale peer info:

```bash
ccs reset-bootstrap-peers --cluster-peername meerkat-ccs
```

### Check replication status

```bash
ccs status <CID> --cluster-peername nas-ccs --basic-auth-file ~/.ccs/config.yml
```

Look for `"status": "pinned"` on each peer.

## Config Files

### ~/.ccs/config.yml

Store cluster credentials for CLI access:

```yaml
cluster:
  basic_auth_user: admin
  basic_auth_password: yourpassword
```

### Tailscale Auth Key

Get reusable auth keys from Tailscale admin console. Save to file and reference with `--ts-authkey-file`.

## Quick Reference

```bash
# Create bootstrap node config
ccs create --cluster-peername NAME --ts-authkey-file FILE --output compose.yml

# Clone config for new node
ccs clone --cluster-peername NAME --bootstrap-host BOOTSTRAP \
  --ts-authkey-file FILE --basic-auth USER:PASS \
  --input bootstrap-compose.yml --output new-compose.yml

# Start containers
docker compose up -d

# Check status
docker compose ps
ccs ls --cluster-peername NAME --basic-auth-file ~/.ccs/config.yml
```
