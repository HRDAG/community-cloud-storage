<!--
Author: PB and Claude
Date: 2025-01-09
License: (c) HRDAG, 2025, GPL-2 or newer

---
docs/docker-setup.md
-->

# Docker Compose Setup Guide

> **DEPRECATED (2026-01-13):** Node deployment is now managed by Ansible.
> See `hrdag-ansible/docs/ccs-role-requirements.md` for the current deployment approach.
> This document is kept for historical reference only.

This guide explains how to deploy CCS (Community Cloud Storage) nodes using Docker Compose.

## Architecture Overview

Each CCS node runs two containers with host networking:

| Container | Purpose |
|-----------|---------|
| `ipfs` | IPFS daemon (kubo) - content storage |
| `ipfs-cluster` | Cluster coordination - replication, pinning |

**Note:** Nodes use host networking and assume the host machine is already on a tailnet (or other private network). No tailscale container is included - machines must be on the tailnet before deploying CCS.

### Port Reference

| Port | Service | Purpose | Access |
|------|---------|---------|--------|
| 4001 | IPFS | Swarm (peer-to-peer replication) | Tailnet only |
| 5001 | IPFS | API (read/write) | Localhost only |
| 8080 | IPFS | Gateway (read-only HTTP) | Tailnet |
| 9094 | Cluster | REST API (add/rm/ls/status) | Tailnet + basic auth |
| 9096 | Cluster | Swarm (cluster peer-to-peer) | Tailnet only |

**Security notes:**
- Port 5001 is hardened to localhost only via `CLUSTER_IPFSHTTP_NODEMULTIADDRESS` in compose template
- Port 9094 requires basic auth credentials
- Ports 4001 and 9096 are for inter-node communication only

## Secrets and How They're Shared

CCS uses two secrets that must be identical across all nodes in a cluster:

| Secret | Purpose | Generated By |
|--------|---------|--------------|
| `CLUSTER_SECRET` | Authenticates cluster peers to each other | `ccs create` on bootstrap node |
| `IPFS_SWARM_KEY` | Creates private IPFS network (nodes only talk to each other) | `ccs create` on bootstrap node |

**Key principle:** Secrets are generated once on the bootstrap node, then automatically extracted and copied when cloning new nodes.

## Prerequisites

1. **Docker** installed on target machine
2. **Host on private network** - Machine must already be on tailnet (or other private network where nodes can reach each other)
3. **CCS installed** on your workstation (run `./install.sh`)
4. **Config file** at `~/.ccs/config.yml` with cluster credentials:
   ```yaml
   cluster:
     basic_auth_user: admin
     basic_auth_password: yourpassword
   ```

## Step 1: Create Bootstrap Node

The first node in the cluster generates the shared secrets.

### On your workstation:

```bash
# Generate compose.yml for bootstrap node
# Use your machine's tailnet hostname as --cluster-peername
ccs create \
  --cluster-peername nas \
  --output compose.yml
```

### On the target machine:

```bash
# Copy compose.yml to target
scp compose.yml nas:/mnt/hrdag-nas/ccs/

# SSH to target and start
ssh nas
cd /mnt/hrdag-nas/ccs
docker compose up -d
```

### Verify bootstrap node:

```bash
# Check containers are running
docker compose ps

# From your workstation, verify cluster responds
ccs ls --cluster-peername nas --basic-auth-file ~/.ccs/config.yml
```

## Step 2: Add Nodes to Cluster

Additional nodes clone their config from the bootstrap node.

### On your workstation:

First, copy the bootstrap node's compose.yml locally:

```bash
scp nas:/mnt/hrdag-nas/ccs/compose.yml nas-compose.yml
```

Then clone config for the new node:

```bash
ccs clone \
  --cluster-peername meerkat \
  --bootstrap-host nas \
  --basic-auth admin:yourpassword \
  --input nas-compose.yml \
  --output meerkat-compose.yml
```

The `clone` command:
1. Reads secrets from the bootstrap node's compose.yml
2. Queries the bootstrap node for its peer IDs via HTTP API
3. Generates bootstrap multiaddrs so the new node can find the cluster
4. Writes a new compose.yml with all the right values

### On the target machine:

```bash
# Copy and start
scp meerkat-compose.yml meerkat:/mnt/sda1/ccs/compose.yml
ssh meerkat
cd /mnt/sda1/ccs
sudo docker compose up -d  # sudo required if user not in docker group
```

**Note:** Some machines require `sudo` for docker commands if the user is not in the `docker` group.

### Verify node joined cluster:

```bash
# From your workstation - should show both peers in peer_map
ccs ls --cluster-peername nas --basic-auth-file ~/.ccs/config.yml
```

## Directory Structure on Nodes

```
/path/to/ccs/
├── compose.yml          # Docker compose config (contains secrets!)
├── ipfs/                # IPFS data (blocks, datastore)
└── ipfs-cluster/        # Cluster state (pins, peer info)
```

**Important:** The `compose.yml` contains secrets (`CLUSTER_SECRET`, `IPFS_SWARM_KEY`, `CLUSTER_RESTAPI_BASICAUTHCREDENTIALS`). Protect it with appropriate permissions (e.g., `chmod 600`).

## Security Notes

### Verifying Port 5001 is Locked

After setup, verify port 5001 is not accessible from the network:

```bash
# Should fail with "connection refused"
curl -m 5 -X POST http://nas:5001/api/v0/id
curl -m 5 -X POST http://meerkat:5001/api/v0/id
```

This is enforced by `CLUSTER_IPFSHTTP_NODEMULTIADDRESS: /ip4/127.0.0.1/tcp/5001` in the compose template.

## Troubleshooting

### Node can't find peers

```bash
# Check cluster peers via ccs
ccs ls --cluster-peername nas --basic-auth-file ~/.ccs/config.yml

# If peer_map shows only one node, manually add bootstrap peer
ccs set-bootstrap-peer --cluster-peername meerkat --bootstrap-host nas
```

### Reset bootstrap peers

If a node has stale peer info:

```bash
ccs reset-bootstrap-peers --cluster-peername meerkat
```

### Check replication status

```bash
ccs status <CID> --cluster-peername nas --basic-auth-file ~/.ccs/config.yml
```

Look for `"status": "pinned"` on each peer. Status `"pinning"` means replication is in progress.

### Restart containers after config change

```bash
# On the node
cd /path/to/ccs
docker compose down
docker compose up -d

# Or to remove orphan containers (e.g., after removing a service)
docker compose down --remove-orphans
docker compose up -d
```

## Quick Reference

```bash
# Create bootstrap node config
ccs create --cluster-peername NAME --output compose.yml

# Clone config for new node
ccs clone --cluster-peername NAME --bootstrap-host BOOTSTRAP \
  --basic-auth USER:PASS \
  --input bootstrap-compose.yml --output new-compose.yml

# Start containers
docker compose up -d

# Check cluster status
ccs ls --cluster-peername NAME --basic-auth-file ~/.ccs/config.yml

# Add file to cluster
ccs add --cluster-peername NAME --basic-auth-file ~/.ccs/config.yml /path/to/file

# Check replication
ccs status CID --cluster-peername NAME --basic-auth-file ~/.ccs/config.yml

# Retrieve file
ccs get CID --cluster-peername NAME --output /path/to/output
```
